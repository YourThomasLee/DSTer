## 核心问题

* 业务需求是什么
  * asp（凤巢检索广告）和feedfmp（原生推荐广告）都会向这个模块发出请求
  * 负责两种类型广告检索
  * 接收adx请求，完成报价
* 涉及哪些数据
* 检索的流程以及策略
* 如何处理程序以实现业务需求

## 相关术语

* 激励视频：完成视频观看后会给予一定奖励的视频，刺激观看

* 频控：一个用户在指定时间看到同一广告的最多次数

  > 一般是指达到次数后会降低广告出现概率，而不是完全不出现

* 闪投：百度信息流动态商品广告细绒，帮助拥有大量商品的广告主实现高效的商品广告投放

* 物料：广告主提供的图片等

* 程序化创意：广告主提供多种标题与物料，系统组合生成广告

* ANN，approximate nearest neighbour：

  * 一系列用于解决最近邻查找问题的近似算法
  * 召回点击率最高的topk广告用于触发，丰富了召回方式

## feedas

> * 功能上可以细分为三部分
> * ref
>   *  [feedas串讲模板](http://wiki.baidu.com/pages/viewpage.action?pageId=1437455652)

### 两大定位

* proxy-server架构，使用remix IOC框架实现，应用层负责开发module业务（填充Request和解析Response）

* 从feedbs和闪投Pamixer拉取候选广告队列，经过策略处理，挑选合适广告返回上游？

  > 粗选到精选的过程？

### Remix框架

* 调度
  * 调度顺序：由modules.conf配置文件指定
  * 调度单元：phase + module
    * phase可配置多个module，phase之间串行
    * modules = 交互类 + 非交互类（FilterModule），依托phase
    * phase内执行流程：请求交互类-请求非交互类-交互类返回

### 细分模块

> * ref
>   * [feed广告投放整体架构](http://wiki.baidu.com/pages/viewpage.action?pageId=1584285733) => 学习七个阶段的概述
>   * [feedas串讲](http://wiki.baidu.com/pages/viewpage.action?pageId=1320237857)
>
> <img src="http://bj.bcebos.com/ibox-thumbnail98/416ba265a34d58637d54d086872b3b62?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T09%3A29%3A58Z%2F1800%2F%2F450acf3157a19f3e8f34bbefa57b3d4cb4ef2bff2375286078ae1d9b0ca28310">
>
> <img src="http://bj.bcebos.com/ibox-thumbnail98/0bdd88bcb637f9218720eef3f7a5b57f?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T09%3A11%3A36Z%2F1800%2F%2F997bd1522c7ed3cea2e0c55fcbb737b5cf4a35b28ebbf47c0278d8dddae22aa2">

#### 五个子系统

<img src="http://bj.bcebos.com/ibox-thumbnail98/53c2576adbfa2382d799ca06af32fded?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T10%3A24%3A46Z%2F1800%2F%2F8dcf577d0f5eb830bd7320eac3ae9a379dfdefedf0d899a268393b45c20a6338">

<img src="http://bj.bcebos.com/ibox-thumbnail98/7bf3100af9961f26bb61df0878b8faca?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T10%3A14%3A07Z%2F1800%2F%2F3da58df320b0c73bed3bb79f9333baa26755274862b2543e6726b5d04f38bf8b">

#### 七大阶段

*   前期：广告检索。与user等模块交互，获取用户意图特征，包括兴趣、地域、词包等 => 传给feedproxy进行广告检索
*   后期：优质广告选取。与观星交互，观星提供价值计算的依据，feedas完成价值预估和计算，评估广告质量。
*   涉及两条数据流
    *   物料流：提供广告信息
    *   预算流：提供广告主开销信息，用于过滤预算花完的广告

> <img src="http://bj.bcebos.com/ibox-thumbnail98/380b92a9241647fac6c0faef5c68d346?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T10%3A26%3A23Z%2F1800%2F%2F4b883ee06342af11815f3af5f709bfa284405e1633ebfcb3be631107a820a25a">

* **数据初始化：DataManagerModule**

  * 进程初始化
  * 注册配置
  * 线程初始化

* **解析请求&预处理：ReqProcessModule**

  * 读取请求并反序列化

  * 读取debugpf头部

  * merge实验参数? 【进一步展开】

  * 获取上游router 

  * 解析asp

  * 计算query 

  * 计算cmatch&gid

  * ges_bid

* **个性化数据获取**

  > <img src="http://bj.bcebos.com/ibox-thumbnail98/75873cba3a2bc0e2add01d5a2ff27347?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A03%3A53Z%2F1800%2F%2Fbb05e7d88d6233ffe00ed84760e040c23b5ac1f879940969c3c0e28f19ea2298">

  * 非交互类

    * **LiteSearchRedisProcessModule**: 获取redis缓存的广告信息，写入advs_from_redis

    * **LiteGoldengateSendProcessModule**：异步发送，返回到轻量金门接收

    * **FeedUserXboxCenterModule**：请求xbox获取用户特征

      > Xbox: 将HDFS大文本文件转换为线上实时检索的平台
      >
      > bes：baidu exchange service，百度营销平台流量交易服务

    * **UnionidProcessModule**：请求uniconid

  * 交互类 | [进一步展开]

    * uas：大数据用户画像平台交互，获取自然属性和session(近期搜索）信息

    * usercenter: 用户历史广告信息

    * upin：获取短期兴趣（凤巢）

    * ums（信息流内容侧用户信息）：获取长短期兴趣 + 视频类别，attention信息

      > user model service

    * IntentService：请求意图中台，获取用户意图query、历史搜索记录

      > Dmp: 提供用户标签，帮助人群定向

* **触发信息准备**

  * 金门处理（交互类）：分析无query流量用户的意图，生成query；对有query流量，优化query质量 => 获取推词 + 激励视频 + 相关性q + 搜索词改写 + query选择

  * userEmbedding（非交互）：请求观星双塔模型，获取userEmbedding，用于广告召回

  * redis（非交互）：获取缓存广告/ums/详情页title/资讯信息

  * xbox（非交互）：请求xbox词表

  * pa预处理（交互）：请求bdrp(分布式redis)、观星，pamixer部分逻辑

    * pamixer：负责请求解析、特征排序等

    > <img src="http://bj.bcebos.com/ibox-thumbnail98/084e048c321f4eaac8e4e21794342d40?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-20T07%3A34%3A27Z%2F1800%2F%2F14ee737c5498131a6edaed198cde62085923ff018ab2b8d9b0dcc1921359815b">

  * 轻量金门接收(非交互类)

  *  FL处理（非交互类）

* **广告触发**

  * feedproxy（交互类）

    * 访问feedbs，广告触发，召回广告队列

    * 请求信息包含：通用信息 + 个性化数据 + 频控数据 + 缓存信息

    * 响应：原始广告队列 + gd广告队列 + 前卡广告队列（搜索结果中排在前面的Ad标识的结果）

      > 搜索的自然结果也可以叫做前卡

  * rtabs(实时询问是否竞价)：特定流量请求广告主是否投放

    * 请求信息：基本信息 + 个性化信息 + cmd + 缓存广告

      > cmd字段表示 trigger group拆分什么意思？

    * 响应：召回广告队列添加到原始广告队列

* **物料获取**

  * adrest（交互类） => 物料优选

    > Adrest: advertisement realtime streaming, 实时广告数据流

    * 根据基础样式召回组件和创意物料
    * 请求：广告 + srcid
    * 响应：解析广告物料 + 创意程序化后的物料 + 优选视频帧 + 优选编辑图 + 图像增强

  * paAdrest（交互类）

    * 闪投流量需要请求pa_adrest获取广告物料

      > 指访问到闪投相关广告位的流量？

  * 物料处理(交互类)：请求mserver，替换特定广告的target_url

    > aserver：基于brpc集成凤巢检索端的基础库mempool、xbuiltin、xbox、yacl等
    >
    > mserver：解决物料长尾检索问题，基于aserver封装多媒体个性化创意检索特有组件
    >
    > <img src="http://bj.bcebos.com/ibox-thumbnail98/4a87ca51333d29ce3d8a411cd6c19544?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-20T08%3A38%3A48Z%2F1800%2F%2F66a0c96c4685ef88f23dab3729973f349a56f6a7e96ce0b3e8a6b4c446708327">

  * feedAdrest(非交互类) | 离线物料优选：请求xbox获取程序化创意的后验数据和策略大师数据

    > 物料相关q值 + 排序过滤截断

* **机制策略 strategy（非交互类）** 【待补充】

  * 策略层级
    * gid层级
    * srcid层级
  * 原理：策略通过插件形式执行逻辑，插件以函数为基本执行单位
  * gid层级
  * srcid层级
    * 根据id优先级先后执行策略逻辑
    * 构建每个id的候选队列，剔除高优先级id选中的广告
    * 执行对应策略
    * 生成srcid的展现逻辑
  * 策略逻辑
    * admit：gid级别广告准入
    * data_prepare：gid级别数据准备，请求观星
    * prepare：srcid级别数据准备，q值调整
    * smart_bid：计算竞价、溢价，调整bid和cpm
    * filter：广告准入，ctr、cpm、q值过滤
    * budget_control: 预算控制
    * dedup：各维度去重
    * price：计费，多种拍卖方法
    * truncate：src_id级别广告过滤，截断

* **后处理 & 打包结果**

  * postprocess（非交互类）：样式处理 + 封装计费串 + 封装mt_json + gd&cpc广告逻辑处理 + 填充前卡广告补余

  * Response：记录所有模块耗时到asplog中

    * 设置各请求级别的asplog

    * 记录个模块耗时

    * 打包请求级别的响应  + 打包广告级别的响应

      > 将元信息在请求中响应 + 具体广告结果在广告级别中响应？

    * 打包结果idl（idl指什么？）

    * pv处理过的后处理逻辑，请求内容写入缓存redis

### 近线系统

> Ref: [近线系统](http://wiki.baidu.com/pages/viewpage.action?pageId=1264588111)

* 作用：之前每次pv广告请求都需要经过完整的召回排序流程，基于时间考虑，难以应用复杂算法提高推荐效果，希望通过nearline和online相结合，利用闲时资源进行错峰计算，提高广告召回效果
* 三种请求
  * 正常请求
  * cache请求
  * 异步请求

