## 粗排概览

> Ref: [feedproxy](http://wiki.baidu.com/pages/viewpage.action?pageId=1447953878)
>
> <img src="http://bj.bcebos.com/ibox-thumbnail98/1e63e1f7a378c9e2d9610158616dc074?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A53%3A37Z%2F1800%2F%2F874534c995ca99cdad8de96f254107bf706d26863c3efceb489ee80e820dffdb">

* 按照规则，将feedas的请求分发到各个bs（如网盟流量走besbs）
* 拆分高低质流量，低质流量（网盟流量）只访问besbs，高质流量（内部流量）访问feedbs、interestbs
* 获取原始广告队列，对返回结果进行多队列排序以及截断
* 预算信息处理

## feedproxy对接的bs模块

> background: feedbs拆分
>
> *『在feedproxy推全后，为解决下游 feedbs 在迁移、部署、扩容时遇到的 cpu 和内存瓶颈，将 feedbs 拆分成了多个集群，即同时并行去请求不同的下游，如feedbs集群，intestbs集群，feedadplus集群，各集群之间采取独立的 production，独立部署迭代』*

<img src="https://gitee.com/WIN0624/document/raw/master/img/fb5175f95b8e7a996d1320a7ca4689a7.png">

* **feedbs** ：针对query词广告请求进行广告检索、质量预估、排序和返回
* **interestbs** ：针对兴趣导向的广告请求进行检索、质量预估、排序及返回
* **besbs**：流量来源为联盟的广告请求进行广告检索、质量预估、排序以及返回
* **feedadplus| 离线广告** ：通过对离线库进行检索，对其余BS召回的广告队列进行补余（基于语义或向量）

## 如何选择对应的bs

*   **由流量类型和cmd控制**
    *   外部流量：besbs（query&兴趣）
    *   内部流量由cmd控制
        *   cmd=1，feedbs（query）
        *   cmd=2，interestbs（兴趣）
        *   cmd=3/4，adplus（隐式触发）

## feedadplus

>   ref
>
>   *   [feedadplus学习](http://wiki.baidu.com/pages/viewpage.action?pageId=955644905)
>   *   [match type和mining type](http://wiki.baidu.com/pages/viewpage.action?pageId=890646783)
>   *   [隐式召回](http://wiki.baidu.com/pages/viewpage.action?pageId=1113893988)

*   **提出背景**

    原本广告召回采用在线和离线串行的方式，而随着触发策略增多，广告召回扩量，cpu的quota过高，影响集群稳定和扩容。此外，广告库也膨胀，导致共同检索不稳定。因此，才对原始feedbs进行微分库。

*   **feedbs微分库**

    *   内部流量：feedbs（关键词触发） + interestbs（画像、意图触发）
    *   联盟流量：besbs（关键词、画像、意图触发）
    *   离线检索：adplus
        *   尤里卡：xbox，人到广告
        *   ANN：annserver，由兴趣触发
        *   EE：离线本地词表

*   **相关术语**

    *   Match_type: 触发方式/广告触发分支
        *   1：query触发
        *   2：词包触发
        *   3：兴趣触发
        *   ...
    *   Mining_type：离线挖掘广告的触发类型

*   **隐式召回**

    *   **概念介绍**

        *   **显式召回**：针对广告主投放定向（query/兴趣/人群）进行显式映射召回

            >   直接用关键词、兴趣获取对应广告

        *   **隐式召回**：通过模型挖掘隐含语义特征，进行触发 =>向量检索

    *   **为什么称为离线？**

        *   离线时，事先用广告信息ideaid、winfoid等计算广告向量128维

*   **feedadplus使用的隐式触发方式**

    *   **尤里卡xbox**：使用as透传的不同信号作为key，共包含3个读取xbox数据的通道

        *   query2ad：以用户搜索的query为key

            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/bf6c61a63c418736c4ad4905b1714178?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T08%3A38%3A54Z%2F1800%2F%2Fbf49951d4246d533b18899a26f75138eb42983f14818e901615abbdcaaef5a07" style="zoom:50%;" >

        *   title2ad：以用户点击广告的title、unitid、自然结果title为key

            >   基于语义向量相似度，进行相关广告获取

        *   cuid2id：以用户cuid为key

        *   it2ad

            *   建立兴趣标签预测模型：从智能定向广告title中抽取兴趣2.0标签
            *   建立兴趣到广告的xbox倒排
            *   用as透传的兴趣信息查xbox获取

    *   **ANN**：触发方式是向量检索，依赖观星获取的annq进行，获取拟合点击率top的广告

        *   用annq检索广告向量kd trww

        >   训练预测预估点击率的双塔模型，之后该模型可用于embedding

    *   **EE离线本地词表**

## feedproxy对接的其他模块

* **内部流量rtabs**：获取预投放广告之后，通过real-time-api实时询问广告主是否决定投放

    > ref: [rtabs全流量通报](http://wiki.baidu.com/pages/viewpage.action?pageId=1009718062)

    * 作用：避免广告主缺乏干预而导致投放成本超标 + 达到精准投放的目的
    * 实现方式：使用当次pv特征请求广告主，由广告主决定广告是否参与竞价并对用户打质量分 (优化预估相关属性标签的准确性)

* **Pamixer**：闪投中控模块，与基础检索模块feedbs并行，接收feedas传来的广告请求并返回合适的广告

* **GD**：保量广告

* **budgetbrpc**：预算控制模块