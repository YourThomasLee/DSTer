## Q1：charge出现异常，从哪几个方面分析

<img src="https://gitee.com/WIN0624/document/raw/master/img/image-20210811111154767.png" alt="image-20210811111154767" style="zoom:67%;" />

### charge计算方式

*   **相关指标**
    *   **有效检索比率** pvr = epv / pv，反映流量利用率，即每次检索的带广告比率
    *   **有效检索对应广告曝光** asn = eshow / epv，反映广告位的利用率，即返回广告时，这些广告是否都有曝光
    *   **检索对应广告曝光** pvr*asn = eshow / pv，反映流量利用率，流量是否都有进行广告曝光
    *   **平均点击价格** acp = price / click

*   **各类广告收费方式**

    *   **CPM广告**：charge = pv * cpm1 = pv * pvr * cpm3 = pv * pvr * asn * cpm2

    *   **CPC广告**：charge = pv * ctr1 * acp = pv * pvr * ctr3 * acp = pv * pvr * asn * ctr2 * acp

    *   **CPA广告**：charge = pv * ctr1 * cvr * tcpa = pv * pvr * ctr3 * cvr * tcpa = pv * pvr * asn * ctr2 * cvr * tcpa

        >   可见 acp = cvr * tcpa

### 各类型广告charge异常分析

当charge出现异常，需要根据计算公式归因到具体指标，可以根据不同的广告类型进行分析：

1.  **针对CPM广告**

*   **分析思路**：『广告计费指标』中，CPM广告可以分别按照**检索pv**、**广告展现show**、**有效检索（含广告检索）epv**、**广告曝光eshow**四个维度进行计费，因此可以从四个角度来分析

*   **各细分粒度归因**

    *   **pv少**，说明该广告位媒体侧的流量出现问题 => 归因到媒体

    *   **show少**，说明广告检索端返回的广告少了 => 可能因素：过滤筛多了、截断数变小了

        <img src="https://gitee.com/WIN0624/document/raw/master/img/image-20210811112507445.png" alt="image-20210811112507445" style="zoom:67%;" />

    *   **同等pv情况下，epv少**，说明**有效检索比率pvr（pv/epv）**低，即流量没有充分利用，没有填充足够广告

    *   **eshow少**

        *   同等epv情况下，说明**有效检索对应广告曝光asn（eshow/epv）**低，即每次带广告检索的曝光率不足，广告位没有被充分利用
        *   同等pv情况下，说明**检索对应广告曝光pvr*asn（eshow/pv）**低，即没有利用好每次流量进行广告曝光

2.  **针对CPC广告**

*   **分析思路**：CPC计费是按点击出价 * 点击通过率CTR转化为CPM统计，即ECPM=acp(平均点击价格) * CTR
*   **若以实际的CTR进行计价**，则按照置顶图中『广告计费指标』可知，是每一次检索、广告展现、有效检索和广告曝光不足，具体可分析为以下原因
    *   ctr1低 => 检索本身少（媒体流量问题）or 检索就没有广告可供用户点击，需要进一步排查pvr
    *   ctr2低 => （返回）展现数本身少 or 展现的没曝光，自然也就无法被点击，可以通过eshow/show验证
    *   ctr3低 => epv本身少（很多pv没有填充广告） or pv中带的广告没曝光（eshow/epv低） 
    *   ectr低 => 广告曝光却没有点击
        *   检索端原因：推送的广告不适合用户，自然无法吸引点击
        *   广告物料原因：物料不够吸引，用户没有点击
*   **若以平台预估点击通过率进行计价**，则收入降低，可能是预估模型出现问题 or 模型特征有异常，可以从模型特征着手分析

3.  **针对CPA广告/OCPC二阶段广告**

*   **分析思路**：CPA广告是按转化出价，则CPM = cpa * cvr(conv/click) * ctr = acp(平均点击价格) * ctr
*   可能是cvr问题：广告主提供的落地页不能吸引点击的用户完成转化
*   可能是ctr问题：物料不能吸引用户完成点击

## Q2：CPM涉及的各个细粒度指标的计算

>   ref: [指标维度](http://wiki.baidu.com/pages/viewpage.action?pageId=854787517)

*   **CPM广告**
    *   CPM1 = 总消费charge / pv * 1000
    *   CPM2 = 总消费charge / show * 1000
    *   CPM3 = 总消费charge / epv * 1000
    *   eCPM = charge / eshow * 1000
*   **CPC广告**
    *   eCPM = acp * ctr
    *   CTR1 = click / pv
    *   CTR2 = click / show
    *   CTR3 = click / epv
    *   eCTR = click / eshow
*   **CPA广告**
    *   eCPM = acp * ctr = tcpa * cvr * ctr
    *   CVR = conv / click （平均每次点击的转化数）

## Q3：不同设备id的优先级

<img src="https://gitee.com/WIN0624/document/raw/master/img/image-20210811143406329.png" alt="image-20210811143406329" style="zoom:67%;" />

*   需要按照id优先级进行数据获取的函数为uas_process_module下的`parse_uas_response`

*   **数据使用优先级**：Userid > cuid > baiduid > device_id（内部优先级idfa > imei > oaid）

    该值会赋予`td.uas_user_id`

    >   <img src="http://bj.bcebos.com/ibox-thumbnail98/6733ec8912361caed05290c87ebdc7dd?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T06%3A42%3A22Z%2F1800%2F%2Ff14a3971bde91e7235e34120f539d95278fbd56cacf4373cb897650588dc5707">
    >
    >   <img src="http://bj.bcebos.com/ibox-thumbnail98/67b5b0f7886bf213a49a46086d620767?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T06%3A42%3A43Z%2F1800%2F%2F04909564a725b872aa7c70779d510ea8bfead7a5c1f73072869693ce9d531ed3">
    >
    >   <img src="http://bj.bcebos.com/ibox-thumbnail98/9a043c681710b22c804dfa03e566c845?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T06%3A42%3A53Z%2F1800%2F%2Fb35cd6d24ae685f3b5b00aad3f2ed4cf582be6889a92d69b136ec2be09b051f1">
    >
    >   <img src="http://bj.bcebos.com/ibox-thumbnail98/12c9a78949d2a85c21364f1e6a2bb6d9?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T06%3A43%3A19Z%2F1800%2F%2Fbf0f87708c0841d6d4ea24f5238d15d14bc9420d025a231dd2a09910c005e94c">

## Q4：adplus和besbs的区别

>   REF
>
>   -   [feedadplus学习](http://wiki.baidu.com/pages/viewpage.action?pageId=955644905)
>   -   [match type和mining type](http://wiki.baidu.com/pages/viewpage.action?pageId=890646783)
>   -   [隐式召回](http://wiki.baidu.com/pages/viewpage.action?pageId=1113893988)

两者区别主要为**召回方式的不同**

*   **besbs属于显式召回**，直接根据feedas透传的query、兴趣作为key，获取广告库中对应的广告id
*   **adplus属于隐式召回**，通过模型挖掘隐含的语义特征，进行触发。以query2ad为例进行说明：
    *   分别根据query和智能定向广告title计算语义向量（广告语义向量离线先算好，在线只需计算query的语义向量）
    *   用query向量检索近似度topn的广告，完成广告召回

## Q5：强扶持和弱扶持有哪些？各自的扶持和退场策略如何？

>   Ref
>
>   *   [实时扶持进场和退场策略](http://wiki.baidu.com/pages/viewpage.action?pageId=1301548779)

*   **扶持类型** `bes_support_type_new`

    *   强扶持
        *   再营销0x01、游戏人群0x02
    *   弱扶持
        *   boost爆量扶持0x08、刷次扶持0x10、智能人群0x20
    *   弱扶持-冷启动0x04

*   **不同扶持的扶持策略及流量划分**

    *   **强扶持**
        *   报价扶持：调整support_adcpm_ratio
    *   **弱扶持**
        *   排序扶持：调整support_cpm_a和support_cpm_b
        *   计费打折：调整support_price_ratio
        *   报价扶持：调整support_adcpm_ratio

    *   **filter阶段影响**

        *   排序分 = 排序分 + boost_cpm_delta (排序分*boost_unit_score)

    *   **最终对ad_cpm的影响**

        *   **第一位广告已经是扶持广告**，则修改扶持cpm、报价和报价系数

            *   扶持cpm：bes_support_sort_cpm = 多目标排序分 + bes_cpm_delta

                >   bes_cpm_delta = (support_cpm_a - 1)*多目标排序分 + support_cpm_b

            *   报价

                *   adv_price_ratio *= support_price_ratio
                *   CPM广告 = price *  price_ratio 或 mincpm / 100 + 0.5
                *   非CPM = price * price_ratio 或 minbid

            *   报价系数

                ad_cpm_ratio *= top1_ratio1 * top1_ratio2 * support_adcpm_ratio

                >   ratio1调节修改后cpm与修改前cpm差异
                >
                >   ratio2调节修改前price与修改后差异

        *   **第一位不是扶持广告**，则修改报价、报价系数和adcpm（修改顺序与上面不同）

            *   **报价**

                *   CPM广告
                    *   排序分=原top1排序分 + 扶持广告bid
                    *   price = 原top1下一位广告排序分/ 100 + 0.5
                *   非CPM广告
                    *   排序分 = 原top1排序分 + 扶持广告bid
                    *   排序q = 扶持广告多目标排序分 / 原top1的bid
                    *   price = 原top1下一位广告排序分 / 排序q + 0.5
                *   打折
                    *   adv_price_ratio *= support_price_ratio
                    *   price *= price_ratio

            *   **报价系数**

                ad_cpm_ratio *= top1_ratio1 * top1_ratio2 * support_adcpm_ratio

                >   ratio1调节修改前与修改后cpm & 修改后cpm与修改前cpm差异（打折前）
                >
                >   ratio2调节修改前price与修改后差异

            *   **最终adcpm**

                *   CPM = ad_cpm_ratio * price * 100
                *   非CPM = ad_cpm_ratio * price * ctrq

*   **各个扶持的退场机制**

    *   **强扶持**

    *   **弱扶持**

        *   **boost退场**：预算消耗完毕则退场

            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/5c13d415ead1989c3cc1202b01a30629?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T11%3A41%3A08Z%2F1800%2F%2F3979c0b2e8a08deb02a2fba9c169459b661b748e272b9037b1e9f13348fd7cc2">

        *   **刷次**：当前deviceid的pv数小于pv限制，才进入扶持逻辑

            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/c07e7767d9d2af7bc085c931b4a646a5?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T12%3A00%3A54Z%2F1800%2F%2F54c995a43d318b14a82ca172e27d98ea5124078366e0cfbc9cfda73c9de756a8">
            >
            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/a9a135549072365d51ddfd5ae81b0e8f?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T12%3A02%3A01Z%2F1800%2F%2Fbf15bc8787542a083b7c4859cc38eb2a35e0f199a658b95a1475e57966181dac">

        *   **智能人群**

    *   **弱扶持-冷启动**：退场机制对应prepare策略中的**bes_coldboot_adv_quit**

        *   **达到整体预算直接退场**（扶持会调高出价，提高成本，所以当前cpm已经超出，则不再进行扶持，导致进一步提高成本）

            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/79029780371d7698af3b825428f8847c?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T12%3A12%3A12Z%2F1800%2F%2F89424b96b319b33066e7a0cf86a88c0c3a38ae1f58a938e03617b339089dc53f">

        *   **单元维度**：每个广告主会有各自退场的cpm（当次cpm）、click和conv阈值，任一维度满足阈值则退场

            >   <img src="http://bj.bcebos.com/ibox-thumbnail98/e645faa191f6cd9f8ae24c893b3ca391?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-11T12%3A15%3A02Z%2F1800%2F%2F88cf6b0d46eaf46bdcdacaaaa14b9d9fe9bd7c56fb42b33382c9cf0e9f867fbf">

## Q6：排序score的具体影响指标

*   精确到各个ratio => 有助于之后进行问题排查和归因
*   有很多策略涉及ratio的变化，以下仅梳理【扶持机制2.0】(bes_support_v2）下908的排序score变化

### prepare策略

*   **插件1：transfer_ratio | 初始分计算**
    *   CPM = bid * q_factor / 10000  = bid * 100
    *   非CPM
        *   排序q = pow(ctrq/10, q_t_value)
        *   排序score = 排序q * bid

*   **插件2：set_bes_strong | 调整报价ratio**

    >   ratio获取优先级：cmatch&tu > cmath&app_sid > cmatch&"0" > 0&"0"

    **bes_support_adcpm_ratio** = 系统初始bes_support_adcpm_ratio * support_adcpm_ratio

*   **插件3：set_bes_cpm_support | 调整排序a/b、计价ratio和报价ratio**

    >   可以同时为boost、刷次和智能人群三种扶持，所以可叠加

    *   **信息来源**

        *   boost：adv->bes_boost_info
        *   刷次：BesDevicePvSupportNewDict
        *   智能人群：AutoMediaDeltaCpmNewDict

    *   **排序扶持**

        *   **bes_supoort_cpm_a** *= boost的cpm_ratio * 刷次的cpm_ratio * 智能人群的cpm_ratio

            >   cpm_ratio要求大于1，否则就用1替代ratio

        *   **bes_support_cpm_b** += boost_info的cpm_delta + 刷次的cpm_delta + 智能人群的cpm_delta

    *   **计费打折**

        *   **bes_support_price_ratio** *= boost_info的price_ratio * 刷次的price_ratio * 智能人群的price_ratio

            >   price_ratio要求大于1e-6，否则就用1替代

    *   **报价扶持**

        *   **bes_support_adcpm_ratio** *= boost_info的adcpm_ratio * 刷次的adcpm_ratio * 智能人群的adcpm_ratio

            >   adcpm_ratio要求大于1e-6，否则就用1替代

### smart_bid策略

*   **CPC广告&OCPC一阶段**

    *   影响bid_ratio的插件：user_smart_bid、bes_smart_bid、feedpayq_bid_ratio
    *   **排序分** = 排序q * bid * bid_ratio

*   **OCPC二阶段**

    *   对应插件：ocpc_bid，调节ocpx_bid_ratio&反馈系数

    *   **使用ctcvrq排序分** = ocpx_bid_ratio * ocpc_bid * ctcvrq/10^7 * 反馈系数 * 计费比

        >   ctcvrq可以看做cvr*ctr

    *   **不使用ctcvrq排序分** =  ocpx_bid_ratio * ocpc_bid * roiq * 排序q * 反馈系数 * 计费比

*   **深度转化双出价广告**

    *   对应插件：ocpc_deep_obid_pk，过程中有调节bid_ratio
    *   **先算转化率roiq**
        *   shallow_roiq = adv->roiq / 10^6
        *   deep_roiq = adv->deeproiq / 10^6
    *   **再算bid**
        *   shallow_bid = ocpc_bid * shallow_roiq
        *   deep_bid = deep_ocpc_bid * bid_ratio * deep_roiq * shallow_roiq
        *   bid = bid * ocpc_deep_shallow_weight + deep_bid * ocpc_deep_bid_weight
    *   **最后根据两个转化的权重计算排序分**
        *   排序分 = 排序q * bid

## Q7：媒体的分成怎么分

>   Ref: [媒体分润和分成](http://wiki.baidu.com/pages/viewpage.action?pageId=1255947883)

*   广告主的付费都是按CPM或排序分倒推CPC收费
*   媒体分润 = 收入 * 税点 * 系数 * r值 * 分成比例

## Q8：Filter策略里面按CPM过滤的有哪些 & 哪个过滤插件过滤程度比较高

>   过滤策略名说明
>
>   *   [0-107](http://wiki.baidu.com/pages/viewpage.action?pageId=771210690)
>
>   *   [137-257](http://wiki.baidu.com/pages/viewpage.action?pageId=1487900781)

### Filter策略中按CPM过滤的插件

*   **插件：thr_filter**

    *   **调节cpm_thr**：影响因素包括match_type、arpu反馈系数 、mincpm_ratio（分行业和地域调节）、displikq、刷新次数、用户偏好、cuid、视频质量、完播eplayq、广告加载、扶持广告门槛调整等

        >   Arpu: 收入/付费用户=单用户平均收入

    *   **计算cpm**

        *   CPM广告: cpm = bid * 100
        *   非CPM广告：cpm = 排序分

    *   **过滤广告**：cpm < cpm_thr

        <img src="http://bj.bcebos.com/ibox-thumbnail98/dd0ff6eed87a7acf9af67ea8a194f912?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-12T02%3A57%3A19Z%2F1800%2F%2F658b3492d164c8f31f3d424ebc026cacbe99302abbdd527cd80ed6b6fe5c67c9">

### 插件过滤程度

*   每个策略的过滤程度在不同的cmatch中占比不同，主要根据【dashboard-检索漏斗-as漏斗-策略过滤】进行分析，以908为例，目前主要过滤策略如下

    <img src="http://bj.bcebos.com/ibox-thumbnail98/65de8bf57a4047f63174475983082e2e?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-08-12T01%3A11%3A24Z%2F1800%2F%2F104e9bb89535ca1a9854152493f40d1ab657029426d4e6b28b1bc2c6e3352cb7" style="zoom:67%;" >

    |         过滤策略名         |                含义                 |              对应插件               |
    | :------------------------: | :---------------------------------: | :---------------------------------: |
    |   DEEPROIQ_FLT_NUM(172)    |           深度转化率过滤            |     filter策略=>deeproiq_filter     |
    |    AS_TRUNCATE_NUM(21)     |           feedas广告截断            | truncate策略=>default_show_control  |
    |     MINBID_FLT_NUM(15)     |           minbid阈值过滤            |       filter策略=>thr_filter        |
    |     ADV_REAMIN_NUM(22)     |                                     |                                     |
    |  TRUE_ADV_REAMIN_NUM(162)  |                                     |                                     |
    |    AD_CPM_FLT_NUM(127)     | CPM过滤（过滤小于ad_min_cpm的广告） |  post_process策略=>ProtectAdcpmNew  |
    |     SRC_MT_FLT_NUM(55)     |           分src_id mt过滤           |        filter策略=>mt_filter        |
    | CONSTANT_SPEED_FLT_NUM(29) |          匀速投放策略过滤           | budget_control=>over_charge_control |
    |    USER_BL_FLT_NUM(11)     |             user黑名单              | filter策略=>blacklist_status_filter |
    | FINAL_MT_JSON_FLT_NUM(146) |        兜底样式json校验过滤         |  post_process策略=>final_mt_filter  |

    

