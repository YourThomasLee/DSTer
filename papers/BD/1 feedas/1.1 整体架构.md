> Ref
>
> * [原生新变更拦截](http://wiki.baidu.com/pages/viewpage.action?pageId=1208287557)
> * [Feed广告投放整体架构](http://wiki.baidu.com/pages/viewpage.action?pageId=1584285733)
> * [feedbs](http://wiki.baidu.com/display/~zhangyifan10/feedbs)
> * [原生广告(new)](http://wiki.baidu.com/pages/viewpage.action?pageId=1370968698)
> * [原生广告架构图](http://wiki.baidu.com/pages/viewpage.action?pageId=1457489166)
> * [feedas串讲](http://wiki.baidu.com/pages/viewpage.action?pageId=1330172488#id-01Feedas串讲-5.1.1prepare_request:)

## 原生框架

* **AFD | Adsense front door**

  * 百度域下所有产品线feed广告流量的统一入口，统一分配和管理广告流量
  * ad=广告，sense=感知，adsense=相关广告

* **涉及模块**

  * dsp：database service provider, 数据库服务提供商

  * asp：advertise select platfrom, 广告选择平台，用于集中分配各频道的广告资源

    > 原本asp和router负责所有广告，后面feed广告要解耦，用天路替代，天路后面又被feedfmp替代
    >
    > router: 用于流量分发
    >
    > ranker部分用到feedas
    >
    > <img src="http://bj.bcebos.com/ibox-thumbnail98/a3cfbef4a399fc0d104512c69a0d014b?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T11%3A38%3A23Z%2F1800%2F%2F05158f0af0b6ed411191a26330122117c4959ac25ad99ce92bf7ccf7b2768519">

  * gd: guranteed delivery, 合约广告，固定广告形式+合约曝光量

  * rtb：实时竞价

* **注意点**

  * 有一段时间由feedas自己请求feedbs和pamixer，后面升级了才由feedproxy进行整合

<img src="http://bj.bcebos.com/ibox-thumbnail98/3530e3715c2e9031a7bf165168aeb0f3?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T09%3A31%3A25Z%2F1800%2F%2F818436e22e99461fd110659345d3b49791c4d7927c15ac1f0a02a6a8c59aa0e2">

<img src="http://bj.bcebos.com/ibox-thumbnail98/7357bc20208696b1924c07fcd2833669?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-20T07%3A34%3A01Z%2F1800%2F%2F0666ed81650b2dfa058432b954caaa6279fd4c925d7a28d38c79f4c37c8edc59">

<img src="http://bj.bcebos.com/ibox-thumbnail98/a73d84e0ab4bee39686acfcee6c0f001?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T02%3A59%3A15Z%2F1800%2F%2F91b6cf18696bd8e3bdf13829daa3f8eb30e6a8ddfba19fc5442809e9cb6c8a69">

## 广告层级结构

*   **广告主**
    *   设置plan(选择推广平台)
    *   设置unit(人群年龄、性别、地域、推广词、意图等特征)
    *   设置广告创意 -> 存入广告库

![image-20210728162354893](https://gitee.com/WIN0624/document/raw/master/img/image-20210728162354893.png)

## 广告投放流程

* 广告主：设置plan(选择推广平台) ->设置unit(人群年龄、性别、地域、推广词、意图等特征) -> 设置广告创意 -> 存入广告库
* 平台：根据用户使用平台记录以及搜索到的用户信息进行用户画像，检索最匹配的广告进行展示

<img src="http://bj.bcebos.com/ibox-thumbnail98/4b93a1516e3f016ea3c04b74e55e2ec7?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A09%3A13Z%2F1800%2F%2Fc3948ed3100fba1075ffb3d2214550e67ea12606a4aa681f23f88f334be2da33">

<img src="http://bj.bcebos.com/ibox-thumbnail98/2f342f19fb716a0619a6701f84f223b2?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A24%3A21Z%2F1800%2F%2Fc0ae90b943e94459ac4a8967c9d907ed27d4a128a312b4943121a2ac6b708bfe">

## 整体流程

#### 接入端

* **AFD**
  
  >   <img src="http://bj.bcebos.com/ibox-thumbnail98/2eb6cef148ee1c3c2bdbe48e9789556b?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T09%3A44%3A06Z%2F1800%2F%2F63af4146113edd20ee81074b82aedb2301459b2c56c2d4943f52db220bb5eab2">
  
  * 百度域下所有产品线feed广告统一入口
  * 接收请求，按照定义规则向下游进行流量分发
  * 屏蔽风险流量 => 不请求广告
  * 返回的广告队列按照规则进行排序和选择
  
* **render** | 渲染
  * AFD选择广告后，由render渲染为原生广告的形式
  
* **xexp**
  * 爱迪生封层流量实验平台
  * 设定参数抽取部分流量进行实验（实验抽样）

#### 缓存

* redis：内存kv
* xbox：分布式kv存储，托管从HDFS上文本文件到在线RPC检索的全流程

#### 后端

* **fmp**

  >   Ref: [fmp](http://wiki.baidu.com/display/~gejiayu/fmp)
  >
  >   <img src="http://bj.bcebos.com/ibox-thumbnail98/0532acf999515fd5d5eb1ca51e5a1424?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T08%3A54%3A01Z%2F1800%2F%2Fe246eee997e0e51fe4266c0b07c4fef8e268bbfc69415c713986d37eae3782e0">

  * 商业新一代的<u>流量中台</u>，取代天路进行上下游之间的交互

  * 未来规划：融合asp(凤巢检索广告)、tianlu(原生推荐广告)，打通凤巢和原生双库，融合router做统一的实验抽样和弹性计算全覆盖

    * fcfmp：替换原有asp(凤巢广告检索)

    * feedfmp：替换原有tianlu => 目前正在进行其与afd的整合

        >   Ref: [afd&feedfmp融合](http://wiki.baidu.com/pages/viewpage.action?pageId=1594922666)
        >
        >   [afd&feedfmp融合设计文档](http://wiki.baidu.com/pages/viewpage.action?pageId=1416869407)
        >
        >   <img src="http://bj.bcebos.com/ibox-thumbnail98/a27f8b5ceccb960e204be2e88ec1bf55?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T09%3A45%3A56Z%2F1800%2F%2Fba42ac9f8d8d27a7b6afafdd5964aa6d7a9c513be2668894aed088dc1b03d017">
        >
        >   <img src="http://bj.bcebos.com/ibox-thumbnail98/524048241c727a1c84852e4b53f2bbad?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-28T09%3A47%3A06Z%2F1800%2F%2F948c83a560bc1e6f35c4ba191bb60c1e8df3268affb507bb6291ecb717cdd37c">

  * 职责

    * 负责上下游协议转换、连接类型适配

      > afd协议为nshead+protobuf; feedas为nshead+idl；
      >
      > 上游短连接；下游长连接

    * 解析并填充请求信息 + 屏蔽风险广告 => 决定是否要请求feedas

    * 实验信息、预算实验信息 

        >   请求router做实验抽样和弹性调度

    * 日志打印

* **feedas** | 精排

  * 高级检索模块，负责整合用户画像和意图数据等信息，交由基础检索模块进行广告检索后进行广告返回

* **feedAdrest**

  * 从广告库中取出广告物料（样式物料和程序化创意）

    > 程序化创意：由数据和算法驱动，对广告创意内容进行智能制作和创意优化

* **金门**

  > Ref: [金门介绍](http://wiki.baidu.com/pages/viewpage.action?pageId=754252677)

  * 将用户画像和意图query化，进行搜索词推荐，得到query化后的各种搜索词及词包
  * 输入：baidu_id、cuid、upin等用户画像特征
  * 输出：query、相似人群包、历史人群包、历史搜索词、兴趣、意图标签等

  > feedas中相关模块：QueryProcessModule + FeedProxyProcessModule

* **观星**

  * 进行各种维度的质量评估，如金门query与用户的相关性、广告排序阶段的点击率预估等
  * Feedctrq: 点击率预估；intentq：广告相关预估

* **feedproxy** | 粗排

  > Ref: [feedproxy](http://wiki.baidu.com/pages/viewpage.action?pageId=1447953878)
  >
  > <img src="http://bj.bcebos.com/ibox-thumbnail98/1e63e1f7a378c9e2d9610158616dc074?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A53%3A37Z%2F1800%2F%2F874534c995ca99cdad8de96f254107bf706d26863c3efceb489ee80e820dffdb">

  * 按照规则，将feedas的请求分发到各个bs（如网盟流量走besbs）
  * 拆分高低质流量，低质流量只访问besbs，高质流量访问feedbs、interestbs
  * 获取原始广告队列，对返回结果进行多队列排序以及截断
  * 预算信息处理

#### feedproxy对接的bs模块

> background: feedbs拆分
>
> *『在feedproxy推全后，为解决下游 feedbs 在迁移、部署、扩容时遇到的 cpu 和内存瓶颈，将 feedbs 拆分成了多个集群，即同时并行去请求不同的下游，如feedbs集群，intestbs集群，feedadplus集群，各集群之间采取独立的 production，独立部署迭代』*

<img src="http://bj.bcebos.com/ibox-thumbnail98/fb5175f95b8e7a996d1320a7ca4689a7?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A55%3A45Z%2F1800%2F%2Fc4ea5656b2bc1efd8768fae179644e06bd6654340f2b20f2578aa1a9540aca2f">

* **feedbs** ：针对query词广告请求进行广告检索、质量预估、排序和返回
* **interestbs** ：针对兴趣导向的广告请求进行检索、质量预估、排序及返回
* **besbs**：流量来源为联盟的广告请求进行广告检索、质量预估、排序以及返回
* **feedadplus| 离线广告** ：通过对离线库进行检索，对其余BS召回的广告队列进行补余

#### feedproxy对接的其他模块

* **rtabs**：获取预投放广告之后，通过real-time-api实时询问广告主是否决定投放

  > ref: [rtabs全流量通报](http://wiki.baidu.com/pages/viewpage.action?pageId=1009718062)

  * 作用：避免广告主缺乏干预而导致投放成本超标 + 达到精准投放的目的
  * 实现方式：使用当次pv特征请求广告主，由广告主决定广告是否参与竞价并对用户打质量分 (优化预估相关属性标签的准确性)

* **Pamixer**：闪投中控模块，与基础检索模块feedbs并行，接收feedas传来的广告请求并返回合适的广告

* **GD**：保量广告

* **budgetbrpc**：预算控制模块

#### User相关

* userCenter：用户频控模块，控制用户在一段时间内看到同广告主、品牌、类别广告的频率

* uas：大数据用户画像平台。能够获取用户自然属性。Eriesed用户画像平台，提供用户基本信息，如年龄、性别、历史query、星座、行业、收入、人生阶段等。

* upin：凤巢用户画像平台。短期兴趣，包括uflow和ubay
  * Uflow: 短期行为数据（在线）
  * ubay：长期挖掘兴趣点数据（离线）
  
* IntentService：意图中台。行为序列、用户画像、长期兴趣、商业意图。

  > 

* ums：信息流内容测用户信息。获取attention信息

### 整体架构图

<img src="http://bj.bcebos.com/ibox-thumbnail98/5188473691030b38d9bb8b65a1191b89?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-20T09%3A11%3A02Z%2F1800%2F%2F3836cf3ade3c190c42bfb55d6e4ff36e540560bb2c9f55e2839859fb7a6aa8aa">

> 上图feedproxy对接的bs少了besbs和interestbs
>
> 图中fmp应为feedfmp
>
> <img src="http://bj.bcebos.com/ibox-thumbnail98/1ea59402a316947c8f77ca3aed5edbbc?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T08%3A18%3A05Z%2F1800%2F%2F38505da3b6c03cc461b8e2db9b578ede56fec98552e5efae6aefe30cc4df5a2b">

* **上游清晰的架构**

<img src="http://bj.bcebos.com/ibox-thumbnail98/2a2e66b1983fc8ddfc4050d5731cf966?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T03%3A43%3A04Z%2F1800%2F%2Fba8f18a4dc58f3a85ae6812d51036dc3e44bfd949b755fad762e25c7b678d1fb">

* **带预算的架构**

<img src="http://bj.bcebos.com/ibox-thumbnail98/6859895dd69252a253fa25b5190c963d?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T07%3A18%3A20Z%2F1800%2F%2F072b0f96db4e209fe8f1d125b879a24e6911869b9e4c278bacb0e27a04cc477e" style="zoom:67%;" >

* **阐明各个子系统的架构**

<img src="http://bj.bcebos.com/ibox-thumbnail98/7bf3100af9961f26bb61df0878b8faca?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T10%3A14%3A07Z%2F1800%2F%2F3da58df320b0c73bed3bb79f9333baa26755274862b2543e6726b5d04f38bf8b">

<img src="http://bj.bcebos.com/ibox-thumbnail98/acae9a8e133928c0bdacbc7947336059?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T06%3A59%3A30Z%2F1800%2F%2F4a17f2f08e5ad960d5931cb149b80eff57f53f8556a6f950efabfdf077c09802">

* **包含feedas内部的架构**

><img src="http://bj.bcebos.com/ibox-thumbnail98/2fff51063676535560494d8c8a454319?authorization=bce-auth-v1%2Ffbe74140929444858491fbf2b6bc0935%2F2021-07-21T06%3A40%3A45Z%2F1800%2F%2Fffc8dbf2281d07e2b68c3762701f52d430a312d6603fd31c6cc283f0766c05cf">